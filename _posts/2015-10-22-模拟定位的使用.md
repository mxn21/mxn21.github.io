---
layout: post
author: mxn
titile: 模拟定位的使用
category: 技术博文
tag: android
---

当你在测试一个使用Location Services基于地理位置的应用时，你是不需要把你的设备从一个地方移动到另一个地方来产生位置数据的。你可以将Location
Services设置成模拟模式。在这个模式里面，你可以发送模拟位置给Location Services，然后Location Services再将这些数据发送给位置client。

使用模拟位置有以下几个优点：

* 模拟位置可以让你创建特定的模拟数据，而不需要你移动你的设备到特定的地方来获取接近的数据。

* 因为模拟位置来源于Location Services，它们可以测试你处理地理位置代码的每一个部分。而且，因为你可以从你的正式版应用之外发送模拟数据，
那么你就不必在发布你的应用之前禁用或者删掉测试代码。

* 因为你不必通过移动设备来产生测试位置，那你就可以使用模拟器来测试应用了。

使用模拟位置最好的方式就是从一个单独的模拟位置的app发送模拟位置数据。

<!-- more -->

## 开启模拟模式

一个应用要想在模拟模式下面给Location Services发送模拟位置 ，那么它必须要设置 ACCESS_MOCK_LOCATION权限。而且，
你必须在测试手机上开启模拟位置选项。

为了在Location Services里面开启模拟模式，你需要连接位置client到Location Services.调用LocationClient.setMockMode(true)方法。
一旦你调用了这个方法，Location Services就会关掉它内部的位置提供器，然后只转发你发给它的模拟位置。
下面展示如何调用LocationClient.setMockMode(true)方法：

    {% highlight java  %}
// Define a LocationClient object
    public LocationClient mLocationClient;
    ...
    // Connect to Location Services
    mLocationClient.connect();
    ...
    // When the location client is connected, set mock mode
    mLocationClinet.setMockMode(true);

     {% endhighlight %}

一旦这个位置client连接上了Location Services，你必须保持这个连接直到你结束发送模拟位置为止。
一旦你调用LocationClient.disconnect()这个方法，Location Services便会开始启用它的内部位置提供器。
在位置client连接的时候调用LocationClient.setMockMode(false)方法就可以关掉模拟模式了。


## 发送模拟位置

一旦你设置好了模拟模式，你就可以创建模拟位置对象了，然后就可以将它们发送给Location Services。接着，
Location Services 又会把这些模拟位置发送给连接的位置clients。

要创建一个新的模拟位置，你要用你的测试数据创建一个新的位置对象。你还需要将提供者的值设为flp，接着Location Services把这些信息放到位置对象里面，
然后发送出去。下面的代码展示了如何创建一个新的模拟位置：

    {% highlight java  %}
  private static final String PROVIDER = "flp";
    private static final double LAT = 37.377166;
    private static final double LNG = -122.086966;
    private static final float ACCURACY = 3.0f;
    ...
    /*
     * From input arguments, create a single Location with provider set to
     * "flp"
     */
    public Location createLocation(double lat, double lng, float accuracy) {
        // Create a new Location
        Location newLocation = new Location(PROVIDER);
        newLocation.setLatitude(lat);
        newLocation.setLongitude(lng);
        newLocation.setAccuracy(accuracy);
        return newLocation;
    }
    ...
    // Example of creating a new Location from test data
    Location testLocation = createLocation(LAT, LNG, ACCURACY);
     {% endhighlight %}

在模拟模式里面，你需要使用LocationClient.setMockLocation()方法来发送模拟位置给Location Services。 例如：

    {% highlight java  %}
mLocationClient.setMockLocation(testLocation);
     {% endhighlight %}

Location Services 将这个模拟位置设为当前位置，接着这个位置会在下一个位置更新来的时候被送出去。

## 运行模拟位置提供应用

待续
