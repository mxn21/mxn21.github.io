---
layout: post
author: mxn
titile: android渲染机制和丢帧分析
category: 技术博文
tag: android
---

自己编写App的时候，有时会感觉界面卡顿，尤其是自定义View的时候，大多数是因为布局的层次过多，存在不必要的绘制，
或者onDraw等方法中过于耗时。那么究竟需要多快，才能给用户一个流畅的体验呢？那么就需要简单了解下Android的渲染机制：

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img68.png)

Android系统每隔16ms发出VSYNC信号，触发对UI进行渲染，那么整个过程如果保证在16ms以内就能达到一个流畅的画面。
那么如果操作超过了16ms就会发生下面的情况：

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img69.png)

<!-- more -->

如果系统发生的VSYNC信号，而此时无法进行渲染，还在做别的操作，那么就会导致丢帧的现象，
（大家在察觉到APP卡顿的时候，可以看看logcat控制台，会有drop frames类似的警告）。这样的话，绘制就会在下一个16ms的时候才进行绘制，
即使只丢一帧，用户也会发现卡顿的。

那为什么是16ms，16ms意味着着1000/60hz，相当于60fps，那么只要解释为什么是60fps。

这是因为人眼与大脑之间的协作无法感知超过60fps的画面更新。12fps大概类似手动快速翻动书籍的帧率，
这明显是可以感知到不够顺滑的。24fps使得人眼感知的是连续线性的运动，这其实是归功于运动模糊的 效果。
24fps是电影胶圈通常使用的帧率，因为这个帧率已经足够支撑大部分电影画面需要表达的内容，同时能够最大的减少费用支出。
但是低于30fps是 无法顺畅表现绚丽的画面内容的，此时就需要用到60fps来达到想要的效果，当然超过60fps是没有必要的。

有了对Android渲染机制基本的认识以后，那么我们的卡顿的原因就在于没有办法在16ms内完成该完成的操作，
而主要因素是在于没有必要的layouts、invalidations、Overdraw。渲染的过程是由CPU与GPU协作完成，
下面一张图很好的展示出了CPU和GPU的工作，以及潜在的问题，检测的工具和解决方案。

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img70.png)

我们需要知道：
1.通过Hierarchy Viewer去检测渲染效率，去除不必要的嵌套
2.通过Show GPU Overdraw去检测Overdraw，最终可以通过移除不必要的背景以及使用canvas.clipRect解决大多数问题。

### Overdraw

Overdraw(过度绘制)描述的是屏幕上的某个像素在同一帧的时间内被绘制了多次。在多层次的UI结构里面，
如果不可见的UI也在做绘制的操作，这就会导致某些像素区域被绘制了多次。这就浪费大量的CPU以及GPU资源。

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img71.png)

当设计上追求更华丽的视觉效果的时候，我们就容易陷入采用越来越多的层叠组件来实现这种视觉效果的怪圈。这很容易导致大量的性能问题，
为了获得最佳的性能，我们必须尽量减少Overdraw的情况发生。

我们可以通过手机设置里面的开发者选项，打开Show GPU Overdraw的选项，可以观察UI上的Overdraw情况。

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img72.png)


蓝色，淡绿，淡红，深红代表了4种不同程度的Overdraw情况，我们的目标就是尽量减少红色Overdraw，看到更多的蓝色区域。

Overdraw有时候是因为你的UI布局存在大量重叠的部分，还有的时候是因为非必须的重叠背景。例如某个Activity有一个背景，
然后里面 的Layout又有自己的背景，同时子View又分别有自己的背景。仅仅是通过移除非必须的背景图片，这就能够减少大量的红色Overdraw区域，
增加 蓝色区域的占比。这一措施能够显著提升程序性能。

### VSYNC(Vertical Synchronization 垂直同步)

为了理解App是如何进行渲染的，我们必须了解手机硬件是如何工作，那么就必须理解什么是VSYNC。

在讲解VSYNC之前，我们需要了解两个相关的概念：

1.Refresh Rate：代表了屏幕在一秒内刷新屏幕的次数，这取决于硬件的固定参数，例如60Hz。
2.Frame Rate：代表了GPU在一秒内绘制操作的帧数，例如30fps，60fps。

GPU会获取图形数据进行渲染，然后硬件负责把渲染后的内容呈现到屏幕上，他们两者不停的进行协作。

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img73.png)

不幸的是，刷新频率和帧率并不是总能够保持相同的节奏。如果发生帧率与刷新频率不一致的情况，
就会容易出现Tearing的现象(画面上下两部分显示内容发生断裂，来自不同的两帧数据发生重叠)。

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img74.png)

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img75.png)

通常来说，帧率超过刷新频率只是一种理想的状况，在超过60fps的情况下，GPU所产生的帧数据会因为等待VSYNC的刷新信息而被Hold住，
这样能够保持每次刷新都有实际的新的数据可以显示。但是我们遇到更多的情况是帧率小于刷新频率。

![](https://raw.githubusercontent.com/mxn21/mxn21.github.io/master/public/img/img76.png)

在这种情况下，某些帧显示的画面内容就会与上一帧的画面相同。糟糕的事情是，帧率从超过60fps突然掉到60fps以下，
这样就会发生LAG，JANK，HITCHING等卡顿掉帧的不顺滑的情况。这也是用户感受不好的原因所在。




